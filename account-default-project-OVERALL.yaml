# CloudFormation Template for Reasonable Account Defaults
# This is the root template that is used to deploy the entire stack.
AWSTemplateFormatVersion: 2010-09-09
Description: Reasonable Account Defaults

Parameters:
  EmailParam:
    #Description: "What is the email address to use for alerts and notifications?"
    Type: String
    AllowedPattern: ^[a-zA-Z0-9]*@[a-zA-Z0-9]*.[a-zA-Z]*$
  AlertThresholdParam:
    #Description: "Cost Anomaly Detector Parameter. Used to alert on cost spikes"
    Type: Number
    Default: 0.01
    MinValue: 0.01
  FixedBudgetParam:
    #Description: "Fixed Budget Parameter. Used to alert based on forecasted monthly spend for all services" 
    Type: Number  
    Default: 0.01
    MinValue: 0.01

Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Notification Address"
        Parameters: 
          - EmailParam
      -
        Label:
          default: "Spend Thresholds"
        Parameters:
          - AlertThresholdParam
          - FixedBudgetParam
      #-
        #Label:
          #default: "Fixed Budget Threshold: What is the forecasted budget amount per month that you want to be alerted about. (For student or Free Tier accounts, the recommendation is the default) <A HREF=https://catalog.us-east-1.prod.workshops.aws/workshops/86e30fc2-daf4-4708-8720-347e2b312075/en-US/foundations/1-budgets>Learn More</A>"
        #Parameters:
    ParameterLabels:
      EmailParam:
        default: "Email Address to receive notification alerts"
      AlertThresholdParam:
        default: "Cost Anomaly Detector Parameter. Used to alert on cost spikes (for student or Free Tier accounts, the recommendation is to use the default)"
      FixedBudgetParam:
        default: "Fixed Budget Threshold: What is the forecasted budget amount per month that you want to be alerted about. (For student or Free Tier accounts, the recommendation is the default) [https://catalog.us-east-1.prod.workshops.aws/workshops/86e30fc2-daf4-4708-8720-347e2b312075/en-US/foundations/1-budgets] " 
        #<A HREF=https://catalog.us-east-1.prod.workshops.aws/workshops/86e30fc2-daf4-4708-8720-347e2b312075/en-US/foundations/1-budgets>Learn More</A>

Resources:
# Budgets
  FixedBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Join
          - "-"
          - - "Reasonable Account Default Fixed Amount Budget (Forecasted)"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
        TimeUnit: MONTHLY
        BudgetType: COST
        BudgetLimit:
          Amount: !Ref FixedBudgetParam
          Unit: USD
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 99
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 80
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam
  AutoAdjust:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Join
          - "-"
          - - "Reasonable Account Default AutoUpdate Budget"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
        TimeUnit: MONTHLY
        BudgetType: COST
        AutoAdjustData:
          AutoAdjustType: HISTORICAL
          HistoricalOptions:
            BudgetAdjustmentPeriod: 6
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 99
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 80
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam

# Cost Anomaly Detectors
  AnomalyMonitor:
    Type: AWS::CE::AnomalyMonitor
    Properties:
      MonitorType: DIMENSIONAL
      MonitorName: Daily-Summary
      MonitorDimension: SERVICE
  AnomalySubscription:
    Type: AWS::CE::AnomalySubscription
    Properties:
      SubscriptionName: !Join
          - "-"
          - - "SubscriptionName"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Threshold: !Ref AlertThresholdParam
      Frequency: DAILY
      MonitorArnList:
        - !Ref AnomalyMonitor
      Subscribers:
        - Type: EMAIL
          Address: !Ref EmailParam