# CloudFormation Template for Reasonable Account Defaults
# This is the root template that is used to deploy the entire stack.
AWSTemplateFormatVersion: 2010-09-09
Description: Reasonable Account Defaults

Parameters:
  EmailParam:
    #Description: "What is the email address to use for alerts and notifications?"
    Type: String
    AllowedPattern: ^[a-zA-Z0-9]*@[a-zA-Z0-9]*.[a-zA-Z]*$
  AlertThresholdParam:
    #Description: "Cost Anomaly Detector Parameter. Used to alert on cost spikes"
    Type: Number
    Default: 0.01
    MinValue: 0.01
  FixedBudgetParam:
    #Description: "Fixed Budget Parameter. Used to alert based on forecasted monthly spend for all services" 
    Type: Number  
    Default: 0.01
    MinValue: 0.01
  LogRetentionDays:
    Type: Number
    Default: 30
    AllowedValues:
      - 1
      - 3
      - 5
      - 7
      - 14
      - 30
      - 60
      - 90
      - 120
      - 150
      - 180
      - 365
      - 400
      - 545
      - 731
      - 1096
      - 1827
      - 2192
      - 2557
      - 2922
      - 3288
      - 3653

Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Notification Address"
        Parameters: 
          - EmailParam
      -
        Label:
          default: "Spend Thresholds"
        Parameters:
          - AlertThresholdParam
          - FixedBudgetParam
      -
        Label:
          default: "Log Retention"
        Parameters:
          - LogRetentionDays
        #Label:
          #default: "Fixed Budget Threshold: What is the forecasted budget amount per month that you want to be alerted about. (For student or Free Tier accounts, the recommendation is the default) <A HREF=https://catalog.us-east-1.prod.workshops.aws/workshops/86e30fc2-daf4-4708-8720-347e2b312075/en-US/foundations/1-budgets>Learn More</A>"
        #Parameters:
    ParameterLabels:
      EmailParam:
        default: "Email Address to receive notification alerts"
      AlertThresholdParam:
        default: "Cost Anomaly Detector Parameter. Used to alert on cost spikes (for student or Free Tier accounts, the recommendation is to use the default)"
      FixedBudgetParam:
        default: "Fixed Budget Threshold: What is the forecasted budget amount per month that you want to be alerted about. (For student or Free Tier accounts, the recommendation is the default) [https://catalog.us-east-1.prod.workshops.aws/workshops/86e30fc2-daf4-4708-8720-347e2b312075/en-US/foundations/1-budgets] " 
        #<A HREF=https://catalog.us-east-1.prod.workshops.aws/workshops/86e30fc2-daf4-4708-8720-347e2b312075/en-US/foundations/1-budgets>Learn More</A>
      LogRetentionDays:
        default: "How many days CW Log Groups will be set to retain data. Default of 30 should generally be good enough"

Resources:
  ################################
  # Budgets
  ################################
  FixedBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Join
          - "-"
          - - "Reasonable Account Default Fixed Amount Budget (Forecasted)"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
        TimeUnit: MONTHLY
        BudgetType: COST
        BudgetLimit:
          Amount: !Ref FixedBudgetParam
          Unit: USD
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 99
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 80
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam
  AutoAdjust:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Join
          - "-"
          - - "Reasonable Account Default AutoUpdate Budget"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
        TimeUnit: MONTHLY
        BudgetType: COST
        AutoAdjustData:
          AutoAdjustType: HISTORICAL
          HistoricalOptions:
            BudgetAdjustmentPeriod: 6
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 99
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 80
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref EmailParam

  ################################
  # Cost Anomaly Detectors
  ################################
  AnomalyMonitor:
    Type: AWS::CE::AnomalyMonitor
    Properties:
      MonitorType: DIMENSIONAL
      MonitorName: Daily-Summary
      MonitorDimension: SERVICE
  AnomalySubscription:
    Type: AWS::CE::AnomalySubscription
    Properties:
      SubscriptionName: !Join
          - "-"
          - - "SubscriptionName"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Threshold: !Ref AlertThresholdParam
      Frequency: DAILY
      MonitorArnList:
        - !Ref AnomalyMonitor
      Subscribers:
        - Type: EMAIL
          Address: !Ref EmailParam

  ################################
  ## CloudTrail Lambda  
  ################################

  ##  - This is created and then invoked, it checks if Cloudtrail is enabled on any of the enabled regions, if there is a CloudTrail, it will exit. If there is no Cloudtrail, it will setup a default trail
  ##  - Cloudtrail is required for the Event Bridge rules that will invoke the S3 Bucket and CW Log Lambdas since they trap Cloudtrail events. 
  ##  - The first Cloudtrail trail is free, so this should not incur a cost other than some S3 bucket storage costs.

  IAMManagedPolicy00policyserviceroleAWSLambdaBasicExecutionRole98371b9437764fd7b9c3bf6c2d311d75007RUo0:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      ManagedPolicyName: !Join
          - "-"
          - - "AWSLambdaBasicExecutionRole-CloudTrail"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Path: "/service-role/"
      Description: ""
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Resource: !Join
          - "-"
          - - { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/CloudtrailSetup" }
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
        #- Resource: { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/CloudtrailSetup-${AWS::StackId}:*" }
          Action: "logs:CreateLogGroup"
          Effect: "Allow"
        - Resource: !Join
          - ""
          - - { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/CloudtrailSetup-" }
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
            - :*
          Action:
          - "logs:CreateLogStream"
          - "logs:PutLogEvents"
          Effect: "Allow"
      #Roles:
      #- "CloudtrailSetup-role-zkreh9rz"
        #Fn::GetAtt:
        #- "IAMRole00CloudtrailSetuprolezkreh9rz00NZ1ax"
        #- "Arn"
        #- Ref: "IAMRole00CloudtrailSetuprolezkreh9rz00NZ1ax"
        #- Ref: "IAMManagedPolicy00policyserviceroleAWSLambdaBasicExecutionRole98371b9437764fd7b9c3bf6c2d311d75007RUo0"
      Users: []
  LambdaFunction00CloudtrailSetup008js0b:
    Type: "AWS::Lambda::Function"
    Properties:
      MemorySize: 512
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 120
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "index.lambda_handler"
      Code:
        ZipFile:  |
          import json
          import boto3
          import cfnresponse
          import os

          def lambda_handler(event, context):

            # Create a Session object

            session = boto3.Session()

            # Set CFINVOKE to True if called from CloudFormation
            CFINVOKE = True if event.get("RequestType") == "Create" else False
            print(f"Value of CFINVOKE is: {CFINVOKE}")

            # List all enabled regions

            ##enabled_regions = session.get_available_regions('cloudtrail')
            # Get Enabled Region List
    
            # Boto Setup
            account_client = boto3.client('account')
            enabled_regions = account_client.list_regions(RegionOptStatusContains=['ENABLED', 'ENABLED_BY_DEFAULT'])
            print ([x["RegionName"] for x in enabled_regions["Regions"]])

            results = []
    
            template_bucket_policy = {

            "Version": "2012-10-17",

            "Statement": [
              {
                "Sid": "AWSCloudTrail",
                "Effect": "Allow",
                "Principal": {
                  "Service": "cloudtrail.amazonaws.com"
                },
                "Action": "s3:GetBucketAcl",
                "Resource": "arn:aws:s3:::$bucket_name",
              },
              {
                "Sid": "AWSCloudTrailWrite",
                "Effect": "Allow",
                "Principal": {
                  "Service": "cloudtrail.amazonaws.com"
                },
                "Action": "s3:PutObject",
                "Resource": "arn:aws:s3:::$bucket_name/AWSLogs/$account_id/*",
                "Condition": {
                  "StringEquals": {
                      "s3:x-amz-acl": "bucket-owner-full-control",
                    }
                  }
                }
              ]
            }

            #print ("enabled_regions", enabled_regions)
            # Iterate over enabled regions

            region_list=[region["RegionName"] for region in enabled_regions["Regions"]]
    
            print ("event", event)
    
            #local_region = event["detail"]["requestParameters"]["AWS_REGION"]
            local_region = context.invoked_function_arn.split(':')[3]
            region=local_region
            region_name=local_region
            #local_region=Regions.fromName(System.getenv("AWS_REGION"))
            print ("local_region", local_region, "region", region)
    
            for region in region_list:
              # Create a CloudTrail client for the current region
              #print ('Testing region ', region)
              cloudtrail_client = session.client('cloudtrail', region_name=region)
              #cloudtrail_client = session.client('cloudtrail')
        
              # Get a list of existing trails
              try:
                #trails = cloudtrail_client.describe_trails()['trailList']
                trails = cloudtrail_client.list_trails()['Trails']


                # Check if any trail exists in the current region

                trail_exists = bool(trails)
            
                results.append({ 'Region': region, 'TrailExists': trail_exists })
        
              except Exception as e:

                # Handle any exceptions that may occur
                print(f"Error in region {region}: {e}")
                cfnresponse.send(event, context, cfnresponse.FAILED, "Error in region {region}: {e}")

            if not trail_exists:

              # Create a default CloudTrail trail
              # First Create the S3 Bucket
        
              #bucket_name = 'your-bucket-name'
              account_id = context.invoked_function_arn.split(':')[4]
              bucket_name = "cloudtrail-logs-" + str(account_id) + "-" + local_region
              #str1 + " " + str2

              print("bucket_name", bucket_name)

              # Create the bucket
    
              s3 = boto3.client('s3')

              try:
                s3.create_bucket(

                  Bucket=bucket_name,

                  CreateBucketConfiguration={

                      'LocationConstraint': local_region  # e.g., 'us-east-1'

                  }

                )
        
                print(f'Bucket {bucket_name} created successfully.')
            
        
                # Add A Bucket Policy

                # Define the replacement function

                replace_vars = lambda s: s.replace("$bucket_name", bucket_name).replace("$account_id", account_id).replace("$local_region", local_region)


                # Replace variables in the JSON object

                replaced_policy = json.loads(json.dumps(template_bucket_policy), object_hook=lambda d: {replace_vars(k): replace_vars(v) if isinstance(v, str) else v for k, v in d.items()})


                # Print the modified JSON object

                bucket_policy = json.dumps(replaced_policy, indent=4)
                #print("bucket_policy", bucket_policy)

                # Set the bucket policy
            
                try:

                  s3.put_bucket_policy(

                      Bucket=bucket_name,

                      Policy=bucket_policy

                  )
                
                  print(f'Bucket {bucket_name} policy created successfully.')

                except Exception as e:

                  # Handle any exceptions that may occur
                  print(f"Error creating bucket policy {bucket_name}: {e}")    
                  cfnresponse.send(event, context, cfnresponse.FAILED, "Error creating bucket policy {bucket_name}: {e}")

              except Exception as e:

                # Handle any exceptions that may occur
                print(f"Error creating bucket {bucket_name}: {e}")
                cfnresponse.send(event, context, cfnresponse.FAILED, "Error creating bucket {bucket_name}: {e}")

            
              # Define the trail configuration

              trail_name = event.get('TrailName', f'default-cloudtrail-{region_name}')
              s3_bucket_name = event.get('S3BucketName', f'cloudtrail-logs-{account_id}-{region_name}')
              is_multi_region_trail = event.get('IsMultiRegionTrail', True) 
              include_global_service_events = event.get('IncludeGlobalServiceEvents', True)
              read_write_type = event.get('ReadWriteType', 'All')  # All, ReadOnly, or WriteOnly

              try:
                # Create the CloudTrail trail
                cloudtrail_client = session.client('cloudtrail', region_name=local_region)
                conn_region = cloudtrail_client.meta.region_name
                print(f"The CloudTrail client is connected to the {conn_region} region.")

                cloudtrail_client.create_trail(

                  Name=trail_name,
                  S3BucketName=s3_bucket_name,
                  IsMultiRegionTrail=is_multi_region_trail,
                  IncludeGlobalServiceEvents=include_global_service_events,
                  EnableLogFileValidation=True #,
                  #ReadWriteType='All'

                )

                try:
                  # Start logging for the trail
                  cloudtrail_client.start_logging(
                    Name=trail_name
                  )
            
                except Exception as e:
                  # Handle any exceptions that may occur
                  print(f"Error in region {region}: {e}")

                print(f"Created a default CloudTrail trail in {region} region: {trail_name}")
                results="Created a default CloudTrail trail in {region} region: {trail_name}"

              except Exception as e:
                # Handle any exceptions that may occur
                print(f"Error in region {region}: {e}")
                cfnresponse.send(event, context, cfnresponse.FAILED, "Error in region {region}: {e}")

              # Append the result to the results list

            if CFINVOKE == True:
              print(f"CFINVOKE is {CFINVOKE}, responding with cfnresponse")
              responseData = {'statusCode': 200, 'body': results}
              print(f"Results  OK {results}")
              #cfnresponse.send(event, context, cfnresponse.SUCCESS)
              cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "Success: {results}")
              #cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")

            else:
              print(f"CFINVOKE is {CFINVOKE}, respnding with Normal Lambda resopnse")
  
              #return results
              return {
                'statusCode': 200,
                'body': (results)
              }

      Role:
        Fn::GetAtt:
        - "IAMRole00CloudtrailSetuprolezkreh9rz00NZ1ax"
        - "Arn"
      FileSystemConfigs: []
      FunctionName: !Join
          - "-"
          - - "CloudtrailSetup"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Runtime: "python3.12"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Join
          - "-"
          - - "/aws/lambda/CloudtrailSetup"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      EphemeralStorage:
        Size: 512
      Architectures:
      - "arm64"
  LogGroupRetention:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Join
          - "-"
          - - "/aws/lambda/CloudtrailSetup"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      RetentionInDays: 30
  IAMRole00CloudtrailSetuprolezkreh9rz00NZ1ax:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/service-role/"
      ManagedPolicyArns:
      - Ref: "IAMManagedPolicy00policyserviceroleAWSLambdaBasicExecutionRole98371b9437764fd7b9c3bf6c2d311d75007RUo0"
      MaxSessionDuration: 3600
      RoleName: !Join
          - "-"
          - - "CloudtrailSetup-role"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Policies:
      - PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Resource: "*"
            Action:
            - "cloudtrail:ListTrails"
            - "cloudtrail:CreateTrail"
            - "cloudtrail:StartLogging"
            Effect: "Allow"
            Sid: "VisualEditor0"
        PolicyName: !Join
          - "-"
          - - "CloudTrail-ListTrails"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      - PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Resource: "*"
            Action: "account:ListRegions"
            Effect: "Allow"
            Sid: "VisualEditor0"
        PolicyName: !Join
          - "-"
          - - "ListRegions"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      - PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Resource: "*"
            Action:
            - "s3:PutBucketAcl"
            - "s3:CreateBucket"
            - "s3:PutBucketPolicy"
            Effect: "Allow"
            Sid: "VisualEditor0"
        PolicyName: "S3-create-bucket"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
  
  InvokeLambda:
    Type: AWS::CloudFormation::CustomResource
    DeletionPolicy: Retain
    Properties:
      ServiceToken: !GetAtt LambdaFunction00CloudtrailSetup008js0b.Arn
      # You can pass any additional parameters to the Lambda function here
      # For example:
      # ParamName: param value
  ################################
  ## Log Retention
  ################################
  IAMRole00CWLogrolekgk39i6m00ZnfTs:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/service-role/"
      ManagedPolicyArns: 
       - Ref: "IAMManagedPolicy00policyserviceroleAWSLambdaBasicExecutionRole05ae902e82be47b29f6df4adf563457e00HVNll"
      MaxSessionDuration: 3600
      RoleName: !Join
          - "-"
          - - "CW-Log-role"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Policies:
      - PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Resource: "*"
            Action:
            - "logs:DescribeLogGroups"
            - "logs:PutRetentionPolicy"
            Effect: "Allow"
            Sid: "VisualEditor0"
        PolicyName: !Join
          - "-"
          - - "CWLogRetentionPush"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"

      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
  LogGroupRetention2:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Join
        - "-"
        - - "/aws/lambda/CW-Log"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - "/"
                  - !Ref "AWS::StackId"
      RetentionInDays: !Ref LogRetentionDays
  LambdaFunction00CWLog00Eude6:
    Type: "AWS::Lambda::Function"
    Properties:
      MemorySize: 512
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 120
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "index.lambda_handler"
      Code:
        ZipFile: |
          import boto3
          import os
          import json

          def lambda_handler(event, context):

            # Print Event Data to see what is coming in
            print('## EVENT')
            print(event)

            # Get the log group name and AWS region from the event data

            #log_group_name = event.get('logGroupName')
            #log_group_name = event['logGroupName']
            log_group_name = event["detail"]["requestParameters"]["logGroupName"]
            print('log_group_name')
            print(log_group_name)

            # Get the region the log was created
            #aws_region = event.get('awsRegion', 'us-east-1')  # Default to us-east-1 if not provided
            aws_region = event["detail"]["awsRegion"]
    
            print('aws_region')
            print(aws_region)
    
            # Get the RETENTION Environment Variable
            retention = int(os.environ.get('RETENTION', 'default_value'))
            #retention = int(reten)
            print(f"Value of RETENTION is: {retention}")

            # Create CloudWatchLogs client with the specified region

            logs_client = boto3.client('logs', region_name=aws_region)

            try:

            # Set the retention policy to retention days

              logs_client.put_retention_policy(

              logGroupName=log_group_name,
              retentionInDays=retention
              )

              print(f"Log retention policy set to {retention} days for log group: {log_group_name} in region: {aws_region}")

            except Exception as e:

              print(f"Error setting log retention policy: {e}")

            return {

              'statusCode': 200,
              'body': 'Lambda function executed successfully'
            }

      Role:
        Fn::GetAtt:
        - "IAMRole00CWLogrolekgk39i6m00ZnfTs"
        - "Arn"
      FileSystemConfigs: []
      FunctionName: !Join
          - "-"
          - - "CW-Log"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Runtime: "python3.12"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Join
          - "-"
          - - "/aws/lambda/CW-Log"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Environment:
        Variables:
          RETENTION: !Ref LogRetentionDays
      EphemeralStorage:
        Size: 512
      Architectures:
      - "arm64"
  IAMManagedPolicy00policyserviceroleAWSLambdaBasicExecutionRole05ae902e82be47b29f6df4adf563457e00HVNll:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      ManagedPolicyName: !Join
          - "-"
          - - "AWSLambdaBasicExecutionRole-LogRetention"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
      Path: "/service-role/"
      Description: ""
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Resource: !Join
          - "-"
          - - { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:/aws/lambda/CW-Log" }
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
        #- Resource: { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*" }
          Action: "logs:CreateLogGroup"
          Effect: "Allow"
        - Resource: !Join
          - ""
          - - { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/CW-Log-" }
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
            - :*
          Action:
          - "logs:CreateLogStream"
          - "logs:PutLogEvents"
          Effect: "Allow"
      #Roles:
      #- Ref: "IAMRole00CWLogrolekgk39i6m00ZnfTs"
      Users: []
  EventsRule00ruleCWLogGroupCreation00IHTUK:
    Type: "AWS::Events::Rule"
    Properties:
      EventBusName: default
        #Ref: "EventsEventBus00default00HBVmY"
      EventPattern:
        detail-type:
        - "AWS API Call via CloudTrail"
        source:
        - "aws.logs"
        detail:
          eventSource:
          - "logs.amazonaws.com"
          eventName:
          - "CreateLogGroup"
      Targets:
      - Arn:
          Fn::GetAtt:
          - "LambdaFunction00CWLog00Eude6"
          - "Arn"
        Id: "Id452bb793-7ba3-49d8-bc98-ad7b060e42d0"
      #Id: "CWLog-GroupCreation"
      State: "ENABLED"
      Name: !Join
          - "-"
          - - "CWLog-GroupCreation"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split
                    - "/"
                    - !Ref "AWS::StackId"
  #EventsEventBus00default00HBVmY:
    #Type: "AWS::Events::EventBus"
    #Properties:
      #Tags: []
      #Name: default
      #!Join
          #- "-"
          #- - "default"
            #- !Select
              #- 0
              #- !Split
                #- "-"
                #- !Select
                  #- 2
                  #- !Split
                    #- "/"
                    #- !Ref "AWS::StackId"
  LambdaPermission00functionCWLog00RAsbF:
    Type: "AWS::Lambda::Permission"
    Properties:
      FunctionName:
        Fn::GetAtt:
        - "LambdaFunction00CWLog00Eude6"
        - "Arn"
      Action: "lambda:InvokeFunction"
      SourceArn:
        #Ref: "EventsRule00ruleCWLogGroupCreation00IHTUK"
        Fn::GetAtt:
          - "EventsRule00ruleCWLogGroupCreation00IHTUK"
          - "Arn"
      Principal: "events.amazonaws.com"

# Outputs
Outputs:
  LambdaInvocationResult:
    Value: !Ref InvokeLambda

  ##TestCustomResource:
    ##Type: "Custom::TestCustomResource"
    ##Properties:
      ##ServiceToken: !GetAtt LambdaFunction00CloudtrailSetup008js0b.Arn
      ###ServiceToken: "ARN of the target Lambda Function"
      ##Parameter1: "string"